<Window x:Class="StickyNote.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:StickyNote"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d"
        Title="ä¾¿ç­¾" Height="300" Width="400"
        MinHeight="150" MinWidth="100"
        WindowStyle="None" 
        AllowsTransparency="True" 
        Background="Transparent"
        ResizeMode="CanResize"
        Icon="{StaticResource AppIconImage}">

    <Window.InputBindings>
        <KeyBinding Command="{x:Static local:MainWindow.NewCmd}" Key="N" Modifiers="Control"/>
        <KeyBinding Command="{x:Static local:MainWindow.DeleteCmd}" Key="D" Modifiers="Control"/>
        <KeyBinding Command="{x:Static local:MainWindow.ToggleTopmostCmd}" Key="T" Modifiers="Control"/>
        <KeyBinding Command="{x:Static local:MainWindow.CloseCmd}" Key="W" Modifiers="Control"/>
        <KeyBinding Command="{x:Static local:MainWindow.ExportCmd}" Key="E" Modifiers="Control"/>
        <KeyBinding Command="{x:Static local:MainWindow.InsertSeparatorCmd}" Key="Enter" Modifiers="Control"/>
    </Window.InputBindings>

    <!-- ä½¿ç”¨ WindowChrome å®žçŽ°çŽ°ä»£åŒ–çš„æ— è¾¹æ¡†ç¼©æ”¾ (æ›¿ä»£ ResizeGrip) -->
    <WindowChrome.WindowChrome>
        <WindowChrome CaptionHeight="30" ResizeBorderThickness="5" GlassFrameThickness="0" CornerRadius="0"/>
    </WindowChrome.WindowChrome>

    <Window.Resources>
        <!-- ç‰›çš®çº¸åº•è‰²ä¸Žæ¨ªçº¿åˆæˆç”»åˆ· -->
        <DrawingBrush x:Key="LinedPaperBrush" Viewport="0,0,1,30" ViewportUnits="Absolute" TileMode="Tile">
            <DrawingBrush.Drawing>
                <DrawingGroup>
                    <GeometryDrawing Brush="#E8D096">
                        <GeometryDrawing.Geometry>
                            <RectangleGeometry Rect="0,0,100,30" />
                        </GeometryDrawing.Geometry>
                    </GeometryDrawing>
                    <GeometryDrawing>
                        <GeometryDrawing.Pen>
                            <Pen Brush="#BFA870" Thickness="1" />
                        </GeometryDrawing.Pen>
                        <GeometryDrawing.Geometry>
                            <LineGeometry StartPoint="0,29" EndPoint="100,29" />
                        </GeometryDrawing.Geometry>
                    </GeometryDrawing>
                </DrawingGroup>
            </DrawingBrush.Drawing>
        </DrawingBrush>

        <!-- 2. æŒ‰é’®æ ·å¼ -->
        <Style TargetType="Button" x:Key="IconBtnStyle">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="WindowChrome.IsHitTestVisibleInChrome" Value="True"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Opacity" Value="0.6"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- 3. å›¾é’‰(ç½®é¡¶)æ ·å¼ -->
        <Style TargetType="ToggleButton" x:Key="PinToggleStyle">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="WindowChrome.IsHitTestVisibleInChrome" Value="True"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Grid Background="Transparent">
                            <!-- å›¾é’‰å›¾æ ‡ -->
                            <Path x:Name="PinPath" 
                                  Data="M12,2 L12,10 L18,16 L18,18 L11,18 L11,23 L9,23 L9,18 L2,18 L2,16 L8,10 L8,2 Z"
                                  Fill="#5D4037" Stretch="Uniform" Width="14" Height="14" RenderTransformOrigin="0.5,0.5">
                                <Path.RenderTransform>
                                    <RotateTransform Angle="45"/>
                                    <!-- é»˜è®¤å€¾æ–œ -->
                                </Path.RenderTransform>
                            </Path>
                        </Grid>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="PinPath" Property="Fill" Value="#3E2723"/>
                                <Setter TargetName="PinPath" Property="RenderTransform">
                                    <Setter.Value>
                                        <RotateTransform Angle="0"/>
                                    </Setter.Value>
                                </Setter>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="PinPath" Property="Width" Value="16"/>
                                <Setter TargetName="PinPath" Property="Height" Value="16"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="PinPath" Property="Width" Value="13"/>
                                <Setter TargetName="PinPath" Property="Height" Value="13"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Window.Resources>

    <!-- ä¸»èƒŒæ™¯å±‚ï¼šé¢œè‰²ç”±æ­¤ Border æŽ§åˆ¶ -->
    <Border x:Name="MainBorder" 
            CornerRadius="2" 
            BorderThickness="1" 
            BorderBrush="#805D4037"
            Background="Transparent">
        <!-- é»˜è®¤ç‰›çš®çº¸è‰² -->

        <Border.Effect>
            <DropShadowEffect Color="Black" BlurRadius="10" ShadowDepth="3" Opacity="0.3"/>
        </Border.Effect>
        <Border.CacheMode>
            <BitmapCache/>
        </Border.CacheMode>

        <!-- å³é”®èœå• -->
        <Border.ContextMenu>
            <ContextMenu>
                <MenuItem Header="æ–°å»ºä¾¿ç­¾ (Ctrl+N)" Click="NewNote_Click"/>
                <Separator/>
                <MenuItem Header="çº¸å¼ é¢œè‰²">
                    <MenuItem Header="ç»å…¸ç‰›çš®çº¸" Click="ChangeColor_Click" Tag="#E3C887"/>
                    <MenuItem Header="æ¨±èŠ±ç²‰" Click="ChangeColor_Click" Tag="#FFCDD2"/>
                    <MenuItem Header="å¤©ç©ºè“" Click="ChangeColor_Click" Tag="#B3E5FC"/>
                    <MenuItem Header="æŠ¤çœ¼ç»¿" Click="ChangeColor_Click" Tag="#DCEDC8"/>
                    <MenuItem Header="æžç®€ç™½" Click="ChangeColor_Click" Tag="#FFF9C4"/>
                    <Separator/>
                    <MenuItem Header="æ·±ç°" Click="ChangeColor_Click" Tag="#424242"/>
                    <MenuItem Header="æœ¨ç‚­é»‘" Click="ChangeColor_Click" Tag="#263238"/>
                    <MenuItem Header="æ©„æ¦„ç»¿" Click="ChangeColor_Click" Tag="#3D5B3D"/>
                </MenuItem>
                <MenuItem Header="é€æ˜Žåº¦">
                    <MenuItem Header="100%" Click="ChangeOpacity_Click" Tag="1.0"/>
                    <MenuItem Header="80%" Click="ChangeOpacity_Click" Tag="0.8"/>
                    <MenuItem Header="50%" Click="ChangeOpacity_Click" Tag="0.5"/>
                </MenuItem>
                <MenuItem Header="æœç´¢ä¾¿ç­¾" Click="Search_Click"/>
                <Separator/>
                <MenuItem Header="å¤åˆ¶ (Ctrl+C)" Click="Copy_Click"/>
                <MenuItem Header="ç²˜è´´ (Ctrl+V)" Click="Paste_Click"/>
                <MenuItem Header="å…¨é€‰ (Ctrl+A)" Click="SelectAll_Click"/>
                <MenuItem Header="å¯¼å‡ºä¸ºæ–‡æœ¬ (Ctrl+E)" Click="Export_Click"/>
                <MenuItem Header="é”å®šå†…å®¹" Click="ToggleLock_Click" IsCheckable="True"/>
                <Separator/>
                <MenuItem Header="æ¸…ç©ºå†…å®¹" Click="Clear_Click"/>
                <MenuItem Header="åˆ é™¤æ­¤ä¾¿ç­¾ (Ctrl+D)" Click="DeleteNote_Click" Foreground="Red"/>
            </ContextMenu>
        </Border.ContextMenu>

        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="100" MinWidth="50" MaxWidth="300"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- å·¦ä¾§æ ‡ç­¾æ  -->
            <Grid Grid.Column="0" Background="#10000000">
                <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <ListBox x:Name="TabList" Grid.Row="0" 
                         Background="Transparent" BorderThickness="0" 
                         ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                         SelectionChanged="TabList_SelectionChanged"
                         MouseDoubleClick="TabList_MouseDoubleClick">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <Grid Margin="0,1">
                                <Grid.ContextMenu>
                                    <ContextMenu>
                                        <MenuItem Header="é‡å‘½å" Click="RenameTab_Click" />
                                        <MenuItem Header="åˆ é™¤" Click="DeleteTab_Click" Foreground="Red" />
                                    </ContextMenu>
                                </Grid.ContextMenu>
                                <StackPanel>
                                    <TextBlock Text="{Binding Title}" FontWeight="Bold" Foreground="#3E2723" TextTrimming="CharacterEllipsis"/>
                                    <TextBlock Text="{Binding Preview}" FontSize="10" Foreground="#5D4037" Opacity="0.7" TextTrimming="CharacterEllipsis" MaxHeight="30"/>
                                </StackPanel>
                            </Grid>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                    <ListBox.ItemContainerStyle>
                        <Style TargetType="ListBoxItem">
                            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                            <Setter Property="Padding" Value="1"/>
                            <Setter Property="Background" Value="Transparent"/>
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="ListBoxItem">
                                        <Border x:Name="Bd" Background="{TemplateBinding Background}" BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="{TemplateBinding BorderThickness}" Padding="{TemplateBinding Padding}" SnapsToDevicePixels="true" CornerRadius="2">
                                            <ContentPresenter HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}" SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}" VerticalAlignment="{TemplateBinding VerticalContentAlignment}"/>
                                        </Border>
                                        <ControlTemplate.Triggers>
                                            <Trigger Property="IsSelected" Value="true">
                                                <Setter TargetName="Bd" Property="Background" Value="#405D4037"/>
                                            </Trigger>
                                            <Trigger Property="IsMouseOver" Value="true">
                                                <Setter TargetName="Bd" Property="Background" Value="#205D4037"/>
                                            </Trigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </ListBox.ItemContainerStyle>
                </ListBox>

                <Button Grid.Row="1" Content="+ æ–°å»ºä¾¿ç­¾" Click="AddTab_Click" Height="30" Margin="5" Style="{StaticResource IconBtnStyle}" Foreground="#5D4037" FontWeight="Bold"/>
            </Grid>

            <!-- åˆ†å‰²çº¿ -->
            <GridSplitter Grid.Column="1" Width="2" HorizontalAlignment="Center" VerticalAlignment="Stretch" Background="#405D4037"/>

            <!-- æ¨ªçº¿å±‚ï¼šä½¿ç”¨åˆæˆç”»åˆ·åŒ…å«åº•è‰²ä¸Žæ¨ªçº¿ -->
            <Grid x:Name="LinesGrid" Grid.Column="2" Background="{StaticResource LinedPaperBrush}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="30"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

            <!-- 1. æ ‡é¢˜æ  -->
            <DockPanel Grid.Row="0" Background="Transparent">
                <StackPanel Orientation="Horizontal" DockPanel.Dock="Left">
                    <Button Style="{StaticResource IconBtnStyle}" Width="30" Click="NewNote_Click" ToolTip="æ–°å»º">
                        <TextBlock Text="+" FontSize="20" FontWeight="Bold" Foreground="#5D4037" Margin="0,-2,0,0"/>
                    </Button>
                    <Button x:Name="PaletteBtn" Style="{StaticResource IconBtnStyle}" Width="30" Click="PaletteButton_Click" ToolTip="æ›´æ”¹é¢œè‰²">
                        <TextBlock Text="ðŸŽ¨" FontSize="16" Foreground="#5D4037"/>
                    </Button>
                </StackPanel>

                <!-- å³ä¾§åŠŸèƒ½åŒº -->
                <StackPanel Orientation="Horizontal" DockPanel.Dock="Right">
                    <ToggleButton x:Name="btnTopmost" Style="{StaticResource PinToggleStyle}" Width="30" Click="PinButton_Click" ToolTip="ç½®é¡¶"/>
                    <Button Style="{StaticResource IconBtnStyle}" Width="30" Click="CloseButton_Click" ToolTip="å…³é—­">
                        <Path Data="M0,0 L10,10 M0,10 L10,0" Stroke="#5D4037" StrokeThickness="2" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                    </Button>
                </StackPanel>
                <!-- æ‹–åŠ¨åŒºåŸŸ (WindowChrome ä¼šè‡ªåŠ¨å¤„ç†ï¼Œåªéœ€é€æ˜ŽèƒŒæ™¯) -->
                <Border Background="Transparent"/>

                <TextBlock x:Name="StatusText" HorizontalAlignment="Center" VerticalAlignment="Center" Foreground="#5D4037" Opacity="0" FontSize="12"/>
            </DockPanel>

            <!-- 2. å†…å®¹è¾“å…¥åŒº -->
            <RichTextBox x:Name="rtbContent"
                         Grid.Row="1"
                         Background="Transparent"
                         BorderThickness="0"
                         FontFamily="Microsoft YaHei"
                         Foreground="#3E2723"
                         Padding="10,2,10,10"
                         VerticalScrollBarVisibility="Hidden"
                         TextChanged="RtbContent_TextChanged"
                         PreviewMouseLeftButtonUp="RtbContent_PreviewMouseLeftButtonUp">
                <RichTextBox.Resources>
                    <Style TargetType="Paragraph">
                        <Setter Property="LineHeight" Value="30"/>
                        <Setter Property="LineStackingStrategy" Value="BlockLineHeight"/>
                    </Style>
                </RichTextBox.Resources>
                <RichTextBox.Template>
                    <ControlTemplate TargetType="RichTextBox">
                        <Border Background="{TemplateBinding Background}" BorderThickness="0">
                            <ScrollViewer x:Name="PART_ContentHost"/>
                        </Border>
                    </ControlTemplate>
                </RichTextBox.Template>
            </RichTextBox>

            <StackPanel Grid.Row="1" Orientation="Horizontal" HorizontalAlignment="Left" VerticalAlignment="Bottom" Margin="6,0,0,6" Background="#20FFFFFF">
                <Button Style="{StaticResource IconBtnStyle}" Width="26" Click="FontInc_Click" ToolTip="å¢žå¤§å­—å·">
                    <TextBlock Text="A" FontSize="16" FontWeight="Bold" Foreground="#5D4037"/>
                </Button>
                <Button Style="{StaticResource IconBtnStyle}" Width="26" Click="FontDec_Click" ToolTip="å‡å°å­—å·">
                    <TextBlock Text="A" FontSize="12" Foreground="#5D4037"/>
                </Button>
                <Button Style="{StaticResource IconBtnStyle}" Width="26" Click="ToggleBold_Click" ToolTip="åŠ ç²—">
                    <TextBlock Text="B" FontSize="14" FontWeight="Bold" Foreground="#5D4037"/>
                </Button>
                <Button Style="{StaticResource IconBtnStyle}" Width="26" Click="ToggleItalic_Click" ToolTip="æ–œä½“">
                    <TextBlock Text="/" FontSize="14" FontStyle="Italic" Foreground="#5D4037"/>
                </Button>
                <Button Style="{StaticResource IconBtnStyle}" Width="26" Click="ToggleUnderline_Click" ToolTip="ä¸‹åˆ’çº¿">
                    <TextBlock Text="U" FontSize="14" TextDecorations="Underline" Foreground="#5D4037"/>
                </Button>
                <Button Style="{StaticResource IconBtnStyle}" Width="26" Click="ToggleStrikethrough_Click" ToolTip="åˆ é™¤çº¿">
                    <TextBlock Text="abc" FontSize="14" Foreground="#5D4037" TextDecorations="Strikethrough"/>
                </Button>
                <Button Style="{StaticResource IconBtnStyle}" Width="26" Click="AlignLeft_Click" ToolTip="å·¦å¯¹é½">
                    <Path Data="M0,3 L14,3 M0,7 L10,7 M0,11 L14,11" Stroke="#5D4037" StrokeThickness="2"/>
                </Button>
                <Button Style="{StaticResource IconBtnStyle}" Width="26" Click="AlignCenter_Click" ToolTip="å±…ä¸­">
                    <Path Data="M2,3 L12,3 M0,7 L14,7 M2,11 L12,11" Stroke="#5D4037" StrokeThickness="2"/>
                </Button>
                <Button Style="{StaticResource IconBtnStyle}" Width="26" Click="AlignRight_Click" ToolTip="å³å¯¹é½">
                    <Path Data="M0,3 L14,3 M4,7 L14,7 M0,11 L14,11" Stroke="#5D4037" StrokeThickness="2"/>
                </Button>
                <Button Style="{StaticResource IconBtnStyle}" Width="26" Click="AddTodo_Click" ToolTip="æ·»åŠ ä»£åŠžäº‹é¡¹">
                    <Path Data="M0,0 L14,0 L14,14 L0,14 Z" Stroke="#5D4037" StrokeThickness="2" Fill="Transparent"/>
                </Button>
            </StackPanel>

            <!-- 3. è‡ªå®šä¹‰å³ä¸‹è§’ Resize Grip (è£…é¥°ç”¨ï¼Œå®žé™…ç¼©æ”¾ç”±WindowChromeå¤„ç†) -->
            <Path Grid.Row="1" HorizontalAlignment="Right" VerticalAlignment="Bottom" 
                  Data="M 0,12 L 12,12 L 12,0 Z" Fill="#405D4037" Margin="0,0,2,2" IsHitTestVisible="False"/>
        </Grid>
        </Grid>
    </Border>
</Window>
